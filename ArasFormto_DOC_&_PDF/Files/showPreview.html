	<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Test Window - Word Document Preview</title>
			<script type="text/javascript">
			var aras = parent.aras || parent.parent.aras;
			document.writeln('<base HREF="' + aras.getScriptsURL() + '" />');
		</script>
		<script
			type="text/javascript"
			src="../javascript/QueryString.js"
		></script>
</head>
<body>
<script>
  if (window.opener && window.opener.document && window.opener.document.thisItem) {
    // Assign Aras thisItem from parent
    document.thisItem = window.opener.document.thisItem;
    top.aras = window.opener.top.aras;
  } else {
    alert("Unable to access parent thisItem. Make sure you're opening from an Aras form.");
  }

  window.onload = previewWordDoc;

    // Converts image to Base64 string
    async function imageToBase64(url) {
        try {
            const response = await fetch(url);
            const blob = await response.blob();
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        } catch (error) {
            console.error(`Failed to load image at ${url}:`, error);
            return '';
        }
    }

    async function convertImagesToBase64(map) {
        const result = {};
        for (const key in map) {
            if (Array.isArray(map[key])) {
                result[key] = await Promise.all(map[key].map(imageToBase64));
            } else {
                result[key] = await imageToBase64(map[key]);
            }
        }
        return result;
    }

    async function previewWordDoc() {
        const templateName = document.thisItem.getProperty("name", "");

        const imageValue1 = "img1.png, img2.png, img3.png, img4.png";
        const hazardImagePaths = imageValue1
            .split(',')
            .map(name => name.trim())
            .filter(Boolean)
            .map(name => `../images/Hazardous/${name}`);

        const imageMap = {
            logo: "../images/demo_logo.png",
            hazardImages: hazardImagePaths
        };

        const imageBase64Map = await convertImagesToBase64(imageMap);
        const htmlContent = getDocumentContent(true, imageBase64Map);

        const previewWindow = window;
        previewWindow.document.open();
        previewWindow.document.write(htmlContent);

       
        previewWindow.document.close();
    }


    // Updated getDocumentContent function
    function getDocumentContent(isEditable = false, images = {}) {
        const base64Img = images.logo || '';
        const base64Images = images.hazardImages || [];

        function getMVS_Data(valueString, listid) {
            const amlRequest = `<AML><Item type="Filter Value" action="get" where="[Filter_Value].source_id='${listid}'" select="filter, value, label, s_longdata"></Item></AML>`;
            const amllist = top.aras.IomInnovator.applyAML(amlRequest);

            const valueToFilterLabelMap = {};
            for (let i = 0; i < amllist.nodeList.length; i++) {
                const node = amllist.nodeList[i];
                const filter = node.querySelector('filter')?.textContent || '';
                const value = node.querySelector('value')?.textContent || '';
                const longData = node.querySelector('s_longdata')?.textContent || '';
                if (value) {
                    valueToFilterLabelMap[value] = {
                        filter,
                        longData
                    };
                }
            }
            const savedvalarr = valueString.split(',').map(val => val.trim()).filter(val => val !== '');
            const groupedByFilter = {};
            savedvalarr.forEach(val => {
                const entry = valueToFilterLabelMap[val];
                if (entry) {
                    const filter = entry.filter;
                    if (!groupedByFilter[filter]) {
                        groupedByFilter[filter] = [];
                    }
                    groupedByFilter[filter].push(entry.longData || val);
                }
            });

            let result = "";
            for (const filter in groupedByFilter) {
                if (groupedByFilter.hasOwnProperty(filter)) {
                    result += `<strong>${filter}:</strong> ${groupedByFilter[filter].join(', ')}<br>`;
                }
            }
            return result;
        }


        // HAZARDOUS SUBSTANCE DESIGNATION AND FIELD OF APPLICATION
        const group = document.thisItem.getProperty("prop1", '');
        const material = document.thisItem.getProperty("prop3", '');
        const workArea = document.thisItem.getProperty("prop4", '');

        const imagepath = "../images/Hazardous/"
        const imgValue1 = "warn_w002.png, warn_w010.png, warn_w011.png, warn_w016.png";


        //const items1 = group.split(",").map(item => item.trim()).filter(Boolean);

        function createSection(title, contents, colWidths = [], centerContent = false) {
            const colCount = contents.length;
            const colWidthStyles = colWidths.length ?
                colWidths.map(w => `width: ${w}%;`) :
                Array(colCount).fill(`width: ${100 / colCount}%;`);
            const applyVerticalBorders = (title === "Section 3" || title === "Section 9");

            const cellsHTML = contents.map((content, idx) => {
                const borderRight = applyVerticalBorders && idx < contents.length - 1 ?
                    'border-right: 4px solid #ff0000;' : '';
                return `
                    <td style="${colWidthStyles[idx]} ${borderRight}">
                        <div ${isEditable ? 'contenteditable="true"' : ''}>
                            ${content}
                        </div>
                    </td>
                `;
            }).join('');

            // Skip title for Sections 1, 3, and 9
            const showTitle = !["Section 1", "Section 3", "Section 9"].includes(title);
            const sectionStyle = centerContent ? 'text-align: center;' : '';
            return `
                    <div class="section-box" style="margin:0px;" >
                        ${showTitle ? `<div class="section-title">${title}</div>` : ''}
                        <table class="section-table" style="margin:0px; padding:0px; ${sectionStyle}">
                            <tr>${cellsHTML}</tr>
                        </table>
                    </div>
                `;
	}
 
 
    const header = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office'
            xmlns:w='urn:schemas-microsoft-com:office:word'
            xmlns='http://www.w3.org/TR/REC-html40'>
        <head>
            <meta charset='utf-8'>
            <title>Word Document Preview</title>
            <style>
				@page { margin: 0.01in;}
				html, body {
					margin: 0;
					padding: 0;
					font-family: Arial, sans-serif;
					background: white;
				}

				table, tr, td {
					border-spacing: 0;
					padding: 0;
					margin: 0;
				}

				table.outer-border {
					width: 100%;
					border: 6px solid #ff0000;
					border-collapse: collapse;
				}

				td.container-cell {
					padding: 0;
					margin: 0;
				}

				.section-box {
					width: 100%;
					padding: 0;
					margin: 0;
					border-bottom: 4px solid #ff0000;
				}

				.section-title {
					background-color: #ff0000;
					text-align: center;
					padding: 0px;
					font-weight: bold;
					font-size: 16px;
					font-style: Arial;
					color: #f4f4f4;
					margin: 0;
				}

				.section-table {
					width: 100%;
					table-layout: fixed;
					border-collapse: collapse;
				}

				.section-table td {
					padding: 0px;
					vertical-align: top;
				}

				[contenteditable="true"] {
					background-color: #ffffff;
					min-height: 20px;
				}

				#downloadBtn, #pdfBtn {
					margin: 20px 10px 10px 0;
					padding: 10px 20px;
					font-size: 16px;
					color: white;
					border: none;
					cursor: pointer;
					border-radius: 4px;
				}

				#downloadBtn { background-color: #4CAF50; }
				#pdfBtn { background-color: #2196F3; }

				@media print {
					body {
						-webkit-print-color-adjust: exact;
						print-color-adjust: exact;
						margin: 20px;
					}
					#downloadBtn, #pdfBtn {
						display: none !important;
					}
				}
			</style>
        </head>
        <body>
            `;
    const footer = `</body></html>`;
 
    const sections =
        createSection("Section 1", [
            "<div></div>",
            `<div style="font-size: 21.5px; font-style: Arial; font-weight: bold;">Work Instruction</div>`,
            `<div style="text-align: right; margin-bottom: 0px;">
                <img src="${base64Img}" alt="Embedded Image" width="80" style="max-width: 90px; height: auto;" />
            </div>`
        ], [25, 50, 25], true) +  
 
        createSection("HAZARDOUS SUBSTANCE DESIGNATION AND FIELD OF APPLICATION", [
            "<strong>Group: </strong>"+group+ "<br>" +
            "<strong>Material: </strong>" + material
        ], [], true) +  
 
createSection("Section 3", [
    `<div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 4px;">
        ${base64Images.map(base64 => `<img src="${base64}" alt="Hazard Image" width="80" style="height: auto;" />`).join('')}
    </div>
    `,
    `<span style="font-size: 13.5px; font-weight: bold; padding-left: 4px;">Work Area(s): </span><span style="font-weight: normal;">${workArea}</span><br>` +
    `<span style="font-size: 13.5px; font-weight: bold; padding-left: 4px;">Activity: </span><span style="font-weight: normal;"></span>`
], [50, 50])+
 
        createSection("HAZARDS FOR HUMANS AND ENVIRONMENT", [
            `<div style="text-align: center; margin-bottom: 0px;">
                <img src="${base64Img}" alt="Embedded Image" width="80" style="max-width: 90px; height: auto;" />
            </div>`,
			`<span style="font-size: 14.5px; font-weight: bold;">H-Statements: </span><span style="font-weight: normal;"></span><br>`+
			`<span style="font-size: 14.5px; font-weight: bold;">Signal word: </span><span style="font-weight: normal;"></span><br>`+
			`<span style="font-size: 14.5px; font-weight: bold;">Other hazards: </span><span style="font-weight: normal;">$</span><br>`
        ], [33.33, 66.66]) +
 
        createSection("PROTECTIVE MEASURES AND RULES OF CONDUCT", [
            `<div style="text-align: center; margin-bottom: 0px;">
                <img src="${base64Img}" alt="Embedded Image" width="80" style="max-width: 90px; height: auto;" />
            </div>`,
            "<br>"+
			`<span style="font-size: 14.5px; font-weight: bold;">Technical protective measures: </span><span style="font-weight: normal;"></span><br>`+
			`<span style="font-size: 14.5px; font-weight: bold;">Organizational protective measures: </span><span style="font-weight: normal;">}</span><br>`+
			`<span style="font-size: 14.5px; font-weight: bold;">Personal protective equipment: </span><span style="font-weight: normal;"></span><br>`+
			`<span style="font-size: 14.5px; font-weight: bold;">Disposal: </span><span style="font-weight: normal;"></span><br>`+
			`<span style="font-size: 14.5px; font-weight: bold;">Transport within premises: </span><span style="font-weight: normal;"></span><br>`
        ], [33.33, 66.66]) +
 
        createSection("BEHAVIOR IN CASE OF DANGER", [
            `<div style="text-align: center; margin-bottom: 0px;">
                <img src="${base64Img}" alt="Embedded Image" width="80" style="max-width: 90px; height: auto;" />
            </div>`,
			`<span style="font-size: 14.5px; font-weight: bold;">General measures: </span><span style="font-weight: normal;"></span><br>`+
			`<span style="font-size: 14.5px; font-weight: bold;">Suitable fire extinguisher: </span><span style="font-weight: normal;"></span><br>`+
			`<span style="font-size: 14.5px; font-weight: bold;">Unsuitable fire extinguisher: </span><span style="font-weight: normal;"></span><br>`+
			`<span style="font-size: 14.5px; font-weight: bold;">Measures for environmental protection: </span><span style="font-weight: normal;"></span><br>`
        ], [33.33, 66.66]) +
 
        createSection("FIRST AID", [
            `<div style="text-align: center; margin-bottom: 0px;">
                <img src="${base64Img}" alt="Embedded Image" width="80" style="max-width: 90px; height: auto;" />
            </div>`,
			`<span style="font-size: 14.5px; font-weight: bold;">General: </span><span style="font-weight: normal;"></span><br>`+
			`<span style="font-size: 14.5px; font-weight: bold;">Inhaling: </span><span style="font-weight: normal;"></span><br>`+
			`<span style="font-size: 14.5px; font-weight: bold;">Skin contact: </span><span style="font-weight: normal;"></span><br>`+
			`<span style="font-size: 14.5px; font-weight: bold;">Eye contact: </span><span style="font-weight: normal;"></span><br>`+
			`<span style="font-size: 14.5px; font-weight: bold;">Swallowing: </span><span style="font-weight: normal;"></span><br>`+
			`<span style="font-size: 14.5px; font-weight: bold;">Additional: </span><span style="font-weight: normal;"></span><br>`
        ], [33.33, 66.66]) +
 
        createSection("PROPER DISPOSAL ", [
            `<div style="text-align: center; margin-bottom: 0px;">
                <img src="${base64Img}" alt="Embedded Image" width="80" style="max-width: 90px; height: auto;" />
            </div>`,
            `<div style="text-align: center; margin-bottom: 0px;">
                <img src="${base64Img}" alt="Embedded Image" width="80" style="max-width: 90px; height: auto;" />
            </div>`
        ], [33.33, 66.66]) +
 
        createSection("Section 9", [
			`<div><span style="font-size: 13.5px; font-family: Arial; font-weight: bold; padding-left: 4px;">Created: </span><br><span style="font-weight: normal; padding-left: 4px; font-size: 10.5px;">Date/Name:</span></div>`,
			`<div><span style="font-size: 13.5px; font-family: Arial; font-weight: bold; padding-left: 4px;">Approved: </span><br><span style="font-weight: normal; padding-left: 4px; font-size: 10.5px;">Date/Name:</span></div>`
        ], [50, 50]);
 
    const pageContainer = `
        <button id="downloadBtn" onclick="downloadEditedDoc()">Download Edited Document</button>
        <button id="pdfBtn" onclick="downloadAsPDF()">Download as PDF</button>
            <table class="outer-border">
                <tr>
                    <td class="container-cell">${sections}</td>
                </tr>
            </table>
        `;
 
            return header + pageContainer + footer;
        }
		
	
function downloadEditedDoc() {
    const clonedDoc = document.documentElement.cloneNode(true);
    clonedDoc.querySelectorAll('#downloadBtn, #pdfBtn, script').forEach(el => el.remove());
    const blob = new Blob(['\ufeff', '<!DOCTYPE html>' + clonedDoc.outerHTML], {
        type: 'application/msword'
    });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'Edited_Template.doc';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function downloadAsPDF() {
    window.print();
}

		
    window.onload = previewWordDoc;
</script>
</body>
</html>
